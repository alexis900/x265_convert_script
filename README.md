# x265 Convert Script

This script automates the conversion of video files to H265 (HEVC) format or changes their container to MKV if they are already in H265 but not in MKV. Additionally, if the estimated size after converting to H265 is larger than the original and the original codec is not H264, the file will be converted to H264 with the `.x264.mkv` extension.

---

## Requirements

- `ffmpeg` and `ffprobe` (for video processing and analysis)
- `xattr` (optional, to mark files with extended attributes)

---

## Quick Usage

1. Convert files in the default directory:
   ```bash
   ./convert_x265.sh
   ```
2. Specify a custom directory:
   ```bash
   ./convert_x265.sh --dir /path/to/my/directory
   ```
3. Process a single file:
   ```bash
   ./convert_x265.sh --file /path/to/my/video.mp4
   ```
4. Show version or help:
   ```bash
   ./convert_x265.sh --version
   ./convert_x265.sh --help
   ```

---

## Main Arguments

- `--help`, `-h`: Show help and options.
- `--version`, `-v`: Show script version.
- `--dir PATH`, `-d PATH`: Directory to process (overrides `ACTUAL_DIR` in `preferences.conf`).
- `--file PATH`, `-f PATH`: Process a single file.
- `--codec CODEC`, `-c CODEC`: Detect the codec of a file.
- `--log-level LEVEL`: Log level (DEBUG, INFO, WARNING, ERROR).
- `--estimate-size`: Estimate the size after H265 conversion for a file.
- `--check-xattr`: Check if the xattr user.larger is present on a file.

If no directory is specified, the one defined in `preferences.conf` will be used.

---

## Environment Variables (`preferences.conf`)

- `ACTUAL_DIR`: Directory containing the videos.
- `LOG_FILE`: Main log file path.
- `FFMPG_LOG_FILE`: ffmpeg output log.
- `REMAINING_LOG`: Log of pending files.
- `CHECK_LATESTS_VERSION`: URL to check for updates.
- `SHARE_PATH`: Shared resources.
- `FFMPEG_PRESET`: ffmpeg preset.
- `FFMPEG_CRF`: Video quality (CRF).
- `FFMPEG_VIDEO_CODEC`: Video codec (default: `libx265`).
- `FFMPEG_AUDIO_CODEC`: Audio codec (default: `copy`).
- `FFMPEG_SUBTITLE_CODEC`: Subtitle codec (default: `srt`).
- `FFMPEG_LOG_LEVEL`: ffmpeg log level (default: `error`).
- `BACKUP_DIR`: Backup folder.
- `LOG_LEVEL`: Script log level (default: `DEBUG`).

---

## Recent Changes and Improvements

- **H265 Size Estimation**: Decides between H265 or H264 based on estimated size.
- **Quality Verification**: Compares duration to ensure integrity.
- **Subtitle Management**: Automatically includes valid subtitles.
- **Backup and Restore**: Safety in case of failures.
- **Signal Handling**: Safe exit and cleanup.
- **Configurable Log Level**: Better output control.

---

## Manual Page (man page)

The script includes a manual page accessible after installation:

```bash
man convert_x265
```

It is installed at `/usr/share/man/man1/convert_x265.1.gz` and is automatically integrated when installing the `.deb` package generated by `create_deb_package.sh`.

---

## Additional Scripts

- `check_x265`: Finds pending files and skips those marked as 'larger'.

---

## Packaging Scripts

- `create_deb_package.sh`: Automates creation of the `.deb` package.

---

## Notes and Best Practices

- The script searches for videos in the configured directory and processes them one by one.
- If there are no pending files, the script waits 10 seconds before searching again.
- It is recommended to check the logs for monitoring and troubleshooting.
- The backup of the original files is deleted only if the conversion is successful.

---

## License

Project under MIT license.