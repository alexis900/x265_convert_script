# x265 Convert Script

This script automates the conversion of video files to H265 (HEVC) format or changes their container to your preferred extension (default: MKV, but configurable, e.g. MP4). If the estimated size after converting to H265 is larger than the original and the original codec is not H264, the file will be converted to H264 with the `.x264.<ext>` extension, where `<ext>` is the chosen output extension.

---

## Requirements

- `ffmpeg` and `ffprobe` (for video processing and analysis)
- `xattr` (optional, to mark files with extended attributes)

---

## Quick Usage

1. Convert files in the default directory:

   ```bash
   ./convert_x265
   ```

2. Specify a custom directory:

   ```bash
   ./convert_x265 --dir /path/to/my/directory
   ```

3. Process a single file:

   ```bash
   ./convert_x265 --file /path/to/my/video.mp4
   ```

4. Show version or help:

   ```bash
   ./convert_x265 --version
   ./convert_x265 --help
   ```

---

## Main Arguments

- `--help`, `-h`: Show help and options.
- `--version`, `-v`: Show script version.
- `--dir PATH`, `-d PATH`: Directory to process (overrides `ACTUAL_DIR` in `preferences.conf`).
- `--file PATH`, `-f PATH`: Process a single file.
- `--codec CODEC`, `-c <file>`: Detect the codec of a file.
- `--log-level LEVEL`: Log level (DEBUG, INFO, WARNING, ERROR).
- `--estimate-size <file>`: Estimate the size after H265 conversion for a file.
- `--check-xattr <file>`: Check if the xattr user.larger is present on a file.
- `--cleanup-temp-files`: Clean up temporary files created during processing.

If no directory is specified, the one defined in `preferences.conf` will be used.

---

## Customizing Output Extension

You can set the output file extension (e.g., `mkv`, `mp4`) by editing the `OUTPUT_EXTENSION` variable in your `config/preferences.conf` file:

```properties
OUTPUT_EXTENSION="mp4"
```

All converted files will use this extension.  
**Example:**  
If you set `OUTPUT_EXTENSION="mp4"`, output files will be named like `video.x265.mp4` or `video.x264.mp4`.

---

## Environment Variables (`preferences.conf`)

- `ACTUAL_DIR`: Directory containing the videos.
- `LOG_FILE`: Main log file path.
- `FFMPEG_LOG_FILE`: ffmpeg output log.
- `REMAINING_LOG`: Log of pending files.
- `OUTPUT_EXTENSION`: Output file extension (default: `mkv`, can be changed to `mp4`, etc.).
- `CHECK_LATESTS_VERSION`: URL to check for updates.
- `SHARE_PATH`: Shared resources.
- `FFMPEG_PRESET`: ffmpeg preset.
- `FFMPEG_CRF`: Video quality (CRF).
- `FFMPEG_VIDEO_CODEC`: Video codec (default: `libx265`).
- `FFMPEG_AUDIO_CODEC`: Audio codec (default: `copy`).
- `FFMPEG_SUBTITLE_CODEC`: Subtitle codec (default: `srt`).
- `FFMPEG_LOG_LEVEL`: ffmpeg log level (default: `error`).
- `BACKUP_DIR`: Backup folder.
- `LOG_LEVEL`: Script log level (default: `DEBUG`).
- `SLEEP_TIME`: Seconds to wait between directory scans.

---

## Recent Changes and Improvements

- **Custom Output Extension**: Set the output file extension via `OUTPUT_EXTENSION` in `preferences.conf`.
- **H265 Size Estimation**: Decides between H265 or H264 based on estimated size.
- **Quality Verification**: Compares duration to ensure integrity.
- **Subtitle Management**: Automatically includes valid subtitles.
- **Backup and Restore**: Safety in case of failures.
- **Signal Handling**: Safe exit and cleanup.
- **Configurable Log Level**: Better output control.

---

## Manual Page (man page)

The script includes a manual page accessible after installation:

```bash
man convert_x265
```

It is installed at `/usr/share/man/man1/convert_x265.1.gz` and is automatically integrated when installing the `.deb` package generated by `create_deb_package.sh`.

---

## Additional Scripts

- `check_x265`: Finds pending files and skips those marked as 'larger'.

---

## Packaging Scripts

- `create_deb_package.sh`: Automates creation of the `.deb` package.

---

## Notes and Best Practices

- The script searches for videos in the configured directory and processes them one by one.
- If there are no pending files, the script waits 10 seconds before searching again.
- It is recommended to check the logs for monitoring and troubleshooting.
- The backup of the original files is deleted only if the conversion is successful.

---

## License

Project under MIT license.

---

## Roadmap

For our future plans and upcoming features, please see our [Roadmap](https://github.com/alexis900/x265_convert_script/blob/main/ROADMAP.md).